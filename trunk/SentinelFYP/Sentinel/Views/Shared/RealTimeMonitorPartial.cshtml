<script src="@Url.Content("~/Scripts/jquery.signalR-1.0.0-rc1.min.js")" type="text/javascript"></script>
<script src="@Url.Content("~/signalr/hubs")" type="text/javascript"></script>

<script type="text/javascript">

    $(function () {
        //Create SignalR object to get communicate with server
        var sentinelHub = $.connection.sentinelHub;

        sentinelHub.client.allLocationUpdates = function (userKey, timestamp, latitude, longitude, speed, orientation, eventType) {
            writeEvent('<br />Update from driver: ' + userKey + '<br />Time: ' + timestamp + " Latitude: " + latitude + " Longitude: " + longitude + " Speed: " + speed + " Orientation: " + orientation, eventType, userKey);
        };

        sentinelHub.client.deliveryUpdate = function (userKey, timestamp, eventType) {
            writeEvent('<br />Driver: ' + userKey + ' made a delivery at: ' + timestamp, eventType, userKey)
        };

        //Write the event to the monitor
        function writeEvent(eventLog, logClass, driverKey) {
            var now = new Date();
            var nowStr = now.getHours() + ':' + now.getMinutes() + ':' + now.getSeconds();

            $('#events-list').prepend('<div class="update ui-state-error-' + logClass + ' ui-corner-all"> <span class="dismiss ui-icon ui-icon-close"></span> <p><a class="ui-icon ui-icon-contact" href="#" val=' + driverKey + '></a></p><p>' + eventLog + '</p></div>');

            doAlert(logClass);
        }

        function doAlert(logClass) {
            if (logClass == 'caution') {
                for (var i = 0; i < 5; i++) {
                    flash('#FFFF00');
                }
            } else if (logClass == 'severe') {
                flash('#CC0033');
            }
        }

        function flash(colour) {
            $("#events-list").stop().css("background-color", "transparent").animate({ backgroundColor: colour }, 500, function () {
                $("#events-list").stop().css("background-color", colour).animate({ backgroundColor: "transparent" }, 500, function () {
                    $("#events-list").stop().css("background-color", "transparent").animate({ backgroundColor: colour }, 500, function () {
                        $("#events-list").stop().css("background-color", colour).animate({ backgroundColor: "transparent" }, 500, function () {
                            $("#events-list").stop().css("background-color", "transparent").animate({ backgroundColor: colour }, 500, function () {
                                $("#events-list").stop().css("background-color", colour).animate({ backgroundColor: "transparent" }, 500);
                            });
                        });
                    });
                });
            });
        }

        $('#scrollbar1').tinyscrollbar();

        $('.dismiss').on('click', function () {
            
            var update = $(this).parents('div:first');
            $(update).slideUp("fast", function() {
                $(update).remove();
            });
        });

        $('.contact').on('click', function () {
            
            var key = $(this).attr('val');
            $.ajax({
                url: '../Monitor/GetDriverContactDetailsPartial',
                data: { strDriverKey: key },
                success: function (data) {
                    $('#events-list').append(data);
                }
            });
        });
    });
</script>

<div id="updates-window-header">
    <span class="span-updates">Real-Time Monitor</span>
</div>
<div id="scrollbar1">
    <div class="scrollbar"><div class="track"><div class="thumb"><div class="end"></div></div></div></div>
    <div class="viewport">
        <div id="events-list" class="overview">
            <div class="update ui-state-error-normal ui-corner-all"> <span class="dismiss ui-icon ui-icon-close"></span> <p><a class="ui-icon ui-icon-contact" href="#"></a></p><p>Normal Event</p></div>
            <div class="update ui-state-error-caution ui-corner-all"> <span class="dismiss ui-icon ui-icon-close"></span> <p><a class="ui-icon ui-icon-contact" href="#"></a></p><p>Cautionary Event</p></div>
            <div class="update ui-state-error-severe ui-corner-all"> <span class="dismiss ui-icon ui-icon-close"></span> <p><a class="ui-icon ui-icon-contact" href="#"></a></p><p>Severe Event</p></div>
        </div>
    </div>
</div>

